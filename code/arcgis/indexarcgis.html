<!--
 * @Author: liuwei 893624020@qq.com
 * @Date: 2024-11-12 16:04:17
 * @LastEditors: liuwei 893624020@qq.com
 * @LastEditTime: 2024-11-12 16:12:08
 * @FilePath: \leaflet\arcgis\indexarcgis.html
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
<!DOCTYPE html>
<html style="overflow: hidden">
  <head>
    <title>arcgis-自定义方案</title>
    <meta name="content-type" content="text/html; charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,target-densitydpi=high-dpi,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
  </head>

  <body onload="init()" style="margin: 0">
    <div
      id="map"
      class="map"
      style="position: absolute; bottom: 0px; top: 0px; width: 100%"
    ></div>

    <!-- leaflet -->
    <link rel="stylesheet" href="../leaflet/leaflet.css" />
    <script src="../leaflet/leaflet.js" type="text/javascript"></script>
    <script
      src="../leaflet/leaflet.tilelayer.wmts.min.js"
      type="text/javascript"
    ></script>
    <script src="../leaflet/CustomWebSDK.js" type="text/javascript"></script>

    <script src="../leaflet/proj4-src.min.js"></script>
    <script src="../leaflet/proj4leaflet.min.js"></script>
    <script>
      var dpi = 96;
      // 米 -> 度（地球球面） 转换系数
      var meterToRadiusRatio = 111194.872221777;
      // 英尺 -> 米 转换系数
      var inchToMeterRatio = 0.0254000508;

      //加载自定义的瓦片(非标准)格式，基于arcgis server测试
      //原点-400,400（左上角）
      //分辨率0.009517 参考图层的描述文件
      // 通过Scale Denominator计算分辨率
      function calcResolution(scaleDenominator) {
        return (
          (2 * (scaleDenominator * inchToMeterRatio)) /
          (dpi * meterToRadiusRatio)
        );
      }

      //再经纬度也就是地理参考系下，L.proj.crs的计算可能是存在问题的，这点可自行探究，经纬度最后需要转换成米,如果是投影下的参考系则是正常的
      function getResolutionByScale(scales) {
        return scales.map((i) => calcResolution(i));
      }

      function init() {
        //限于局域网访问
        const testurl3 =
          "http://172.16.4.105:6080/arcgis/rest/services/testmap/MyMapService/MapServer/tile/{z}/{y}/{x}";

        const resolutions = [
          0.0095178440233211203, 0.0047589220116605602, 0.0023794610058302801,
          0.00118973050291514, 0.00059486525145757002, 0.00029743262572878501,
          0.00015228550437313792, 7.6142752186568962e-5, 3.8071376093284481e-5,
        ];

        //如果只有scale信息需要计算resolution出来，原因在于L.proj.crs的计算可能是存在问题的在地理参考系下
        const crs4490 = new L.Proj.CRS(
          "EPSG:4490",
          "+proj=longlat +ellps=GRS80 +no_defs +type=crs",
          {
            resolutions: resolutions,
            origin: [-400, 400],
          }
        );

        const map = L.map("map", {
          crs: crs4490,
          //maxzoom,minzoom以及layer的zoom需在0-8 总共只有九级别
        }).setView([30.488466965192984, 114.55365478992464], 5);

        addWMTSLayer(map, testurl3, "846d7b91-d2a3-4edb-978c-48063e2840ef");
      }

      function addWMTSLayer(map, url, token) {
        new L.TileLayer(url, {
          tileSize: 512, //tilesize为256时，zoomoffset为1，这点在加载是需要注意，背后的原因在于第一级是1个图片还是2个图片
          zoomOffset: 0,
        }).addTo(map);
      }
    </script>
  </body>
</html>
